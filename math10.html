<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S4 Math Scoring System</title>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --primary: #3b82f6; --text: #1e293b;
            --subj-bg: #f1f5f9; --sel-bg: #eff6ff;
            --success: #22c55e; --error: #ef4444;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; touch-action: manipulation; }
        body { background: var(--bg); margin: 0; padding: 20px; padding-bottom: 350px; display: flex; justify-content: center; color: var(--text); }
        .container { width: 100%; max-width: 800px; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* Menu Grid */
        h2 { text-align: center; margin-bottom: 20px; }
        .theme-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .theme-btn {
            padding: 15px; border: 1px solid #cbd5e1; background: white; border-radius: 12px;
            font-weight: 600; cursor: pointer; transition: 0.2s; text-align: left;
        }
        .theme-btn:hover { border-color: var(--primary); background: var(--sel-bg); color: var(--primary); }

        /* Exam View */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .back-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .status { font-size: 0.9rem; font-weight: bold; color: #64748b; }

        /* OMR Grid - Dynamic Auto Fill */
        .omr-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 10px; margin-bottom: 30px;
        }
        .q-box { display: flex; flex-direction: column; align-items: center; }
        .q-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .q-input {
            width: 100%; height: 50px; text-align: center; font-size: 1.1rem; font-weight: bold;
            border: 1px solid #cbd5e1; border-radius: 10px; background: white; 
            cursor: pointer; caret-color: transparent; /* Hide cursor */
        }
        .q-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        
        /* Input Types Colors */
        .q-input.subjective { background-color: var(--subj-bg); }
        .q-input.selection { background-color: var(--sel-bg); color: var(--primary); border-color: #bfdbfe; }
        
        /* Grading */
        .q-input.correct { background-color: #dcfce7; border-color: var(--success); color: #15803d; }
        .q-input.wrong { background-color: #fee2e2; border-color: var(--error); color: #b91c1c; }

        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .submit-btn:disabled { background: #94a3b8; }

        /* Overlays */
        .overlay-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 900; display: none; backdrop-filter: blur(2px); }
        .overlay-bg.visible { display: block; }

        /* Keypad */
        #keypad {
            position: fixed; bottom: -100%; left: 0; width: 100%; background: #1e293b;
            padding: 20px; border-radius: 20px 20px 0 0; transition: bottom 0.3s ease; z-index: 1000;
        }
        #keypad.visible { bottom: 0; }
        .kp-header { display: flex; justify-content: space-between; color: white; margin-bottom: 15px; align-items: center; }
        .kp-preview { font-size: 1.5rem; font-weight: bold; color: #60a5fa; }
        .kp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
        .kp-btn { height: 50px; border-radius: 8px; border: none; font-size: 1.25rem; font-weight: 600; cursor: pointer; background: white; box-shadow: 0 2px 0 #94a3b8; }
        .kp-btn:active { transform: translateY(2px); box-shadow: none; }
        .kp-submit { grid-column: span 2; background: var(--primary); color: white; box-shadow: 0 2px 0 #1d4ed8; }

        /* Modal (Selection) */
        #modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; background: white; padding: 20px;
            border-radius: 16px; z-index: 1001; display: none; max-height: 80vh; overflow-y: auto;
        }
        #modal.visible { display: block; }
        .choice-item { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; gap: 10px; }
        .choice-item:hover { background: #eff6ff; border-color: var(--primary); }
        .choice-idx { font-weight: bold; color: var(--primary); flex-shrink: 0;}
    </style>
</head>
<body>

<div class="overlay-bg" id="overlay" onclick="closeOverlays()"></div>

<div class="container">
    <div id="view-menu">
        <h2>수학 채점 시스템</h2>
        <div class="theme-list" id="theme-list"></div>
    </div>

    <div id="view-exam" class="hidden">
        <div class="header">
            <button class="back-btn" onclick="goHome()">←</button>
            <span id="exam-title" style="font-weight:bold;">Theme Title</span>
            <span class="status" id="exam-status">0/5</span>
        </div>
        <div class="omr-grid" id="omr-grid"></div>
        <button class="submit-btn" id="submit-btn" onclick="submitExam()">채점하기</button>
    </div>
</div>

<div id="keypad">
    <div class="kp-header">
        <span>답안 입력</span>
        <span class="kp-preview" id="kp-display"></span>
        <button onclick="closeOverlays()" style="background:none; border:none; color:white; font-size:1.5rem;">×</button>
    </div>
    <div class="kp-grid">
        <button class="kp-btn" onclick="kpInput('1')">1</button>
        <button class="kp-btn" onclick="kpInput('2')">2</button>
        <button class="kp-btn" onclick="kpInput('3')">3</button>
        <button class="kp-btn" style="background:#e2e8f0" onclick="kpInput('+')">+</button>
        <button class="kp-btn" onclick="kpInput('4')">4</button>
        <button class="kp-btn" onclick="kpInput('5')">5</button>
        <button class="kp-btn" onclick="kpInput('6')">6</button>
        <button class="kp-btn" style="background:#e2e8f0" onclick="kpInput('-')">-</button>
        <button class="kp-btn" onclick="kpInput('7')">7</button>
        <button class="kp-btn" onclick="kpInput('8')">8</button>
        <button class="kp-btn" onclick="kpInput('9')">9</button>
        <button class="kp-btn" style="background:#e2e8f0" onclick="kpInput('/')">/</button>
        <button class="kp-btn" onclick="kpInput('.')">.</button>
        <button class="kp-btn" onclick="kpInput('0')">0</button>
        <button class="kp-btn" style="background:#e2e8f0" onclick="kpInput('√')">√</button>
        <button class="kp-btn" style="background:#cbd5e1" onclick="kpBack()">⌫</button>
        <button class="kp-btn" style="background:#cbd5e1" onclick="kpClear()">C</button>
        <button class="kp-btn kp-submit" onclick="closeOverlays()">입력</button>
    </div>
</div>

<div id="modal">
    <h3 id="modal-title" style="margin-top:0;">선택</h3>
    <div id="modal-list"></div>
    <button onclick="closeOverlays()" style="width:100%; padding:10px; margin-top:10px; border:none; background:#f1f5f9; border-radius:8px;">닫기</button>
</div>

<script src="math10_data.js"></script> 

<script>
    // --- State Management ---
    let currentTheme = null;
    let activeInputId = null;
    const MAX_ATTEMPTS = 5;

    // --- DOM Elements ---
    const els = {
        menu: document.getElementById('view-menu'),
        exam: document.getElementById('view-exam'),
        themeList: document.getElementById('theme-list'),
        examTitle: document.getElementById('exam-title'),
        examStatus: document.getElementById('exam-status'),
        grid: document.getElementById('omr-grid'),
        submitBtn: document.getElementById('submit-btn'),
        
        overlay: document.getElementById('overlay'),
        keypad: document.getElementById('keypad'),
        kpDisplay: document.getElementById('kp-display'),
        modal: document.getElementById('modal'),
        modalList: document.getElementById('modal-list'),
        modalTitle: document.getElementById('modal-title')
    };

    // --- Initialization ---
    function init() {
        if(typeof MATH_DATA === 'undefined') {
            alert("데이터 파일(math10_data.js)이 로드되지 않았습니다.");
            return;
        }
        renderMenu();
    }

    function renderMenu() {
        els.themeList.innerHTML = '';
        MATH_DATA.forEach(theme => {
            const btn = document.createElement('button');
            btn.className = 'theme-btn';
            btn.textContent = theme.title;
            btn.onclick = () => loadTheme(theme);
            els.themeList.appendChild(btn);
        });
    }

    // --- Exam Logic ---
    function loadTheme(theme) {
        currentTheme = theme;
        els.menu.classList.add('hidden');
        els.exam.classList.remove('hidden');
        els.examTitle.textContent = theme.title;
        
        // Load History
        const saved = JSON.parse(localStorage.getItem(`s4_${theme.id}`)) || { attempts: 0, bestScore: 0 };
        const isLocked = saved.attempts >= MAX_ATTEMPTS;
        
        els.examStatus.textContent = `시도: ${saved.attempts}/${MAX_ATTEMPTS} (최고: ${saved.bestScore}점)`;
        els.submitBtn.disabled = isLocked;
        els.submitBtn.textContent = isLocked ? "제출 횟수 초과" : "채점하기";

        renderGrid(theme.questions, isLocked);
    }

    function renderGrid(questions, isLocked) {
        els.grid.innerHTML = '';
        questions.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = 'q-box';
            
            const label = document.createElement('span');
            label.className = 'q-label';
            label.textContent = q.no; // "1", "3-(1)" 등 데이터 그대로 표시

            const input = document.createElement('input');
            input.id = `q-${idx}`;
            input.readOnly = true; // 가상키패드/모달 강제 사용
            input.placeholder = q.type === 'selection' ? '선택' : '?';
            
            // 클래스 지정 (색상 구분)
            let cls = 'q-input';
            if(q.type === 'selection') cls += ' selection';
            else cls += ' subjective';
            input.className = cls;

            if(!isLocked) {
                input.onclick = () => {
                    if(q.type === 'selection') openModal(idx, q);
                    else openKeypad(idx, input.value);
                };
            } else {
                input.disabled = true;
            }

            box.appendChild(label);
            box.appendChild(input);
            els.grid.appendChild(box);
        });
    }

    function goHome() {
        if(confirm("목록으로 돌아갑니다. 입력 내용이 초기화됩니다.")) {
            els.exam.classList.add('hidden');
            els.menu.classList.remove('hidden');
            closeOverlays();
        }
    }

    // --- Input Handlers ---
    function openKeypad(idx, currentVal) {
        activeInputId = idx;
        els.kpDisplay.textContent = currentVal;
        
        document.getElementById(`q-${idx}`).classList.add('active'); // Highlight (Optional)
        els.overlay.classList.add('visible');
        els.keypad.classList.add('visible');
    }

    function kpInput(val) {
        if(activeInputId === null) return;
        const input = document.getElementById(`q-${activeInputId}`);
        // 글자수 제한 (선택사항)
        if(input.value.length < 10) {
            input.value += val;
            els.kpDisplay.textContent = input.value;
        }
    }

    function kpBack() {
        if(activeInputId === null) return;
        const input = document.getElementById(`q-${activeInputId}`);
        input.value = input.value.slice(0, -1);
        els.kpDisplay.textContent = input.value;
    }

    function kpClear() {
        if(activeInputId === null) return;
        const input = document.getElementById(`q-${activeInputId}`);
        input.value = "";
        els.kpDisplay.textContent = "";
    }

    // --- Modal Handlers ---
    function openModal(idx, qData) {
        activeInputId = idx;
        els.modalList.innerHTML = '';
        els.modalTitle.textContent = `${qData.no}번 선택`;

        qData.choices.forEach((text, i) => {
            const choiceNum = i + 1;
            const div = document.createElement('div');
            div.className = 'choice-item';
            div.innerHTML = `<span class="choice-idx">(${choiceNum})</span> <span>${text}</span>`;
            div.onclick = () => {
                document.getElementById(`q-${idx}`).value = choiceNum; // 저장되는 값은 번호(1,2..)
                closeOverlays();
            };
            els.modalList.appendChild(div);
        });

        els.overlay.classList.add('visible');
        els.modal.classList.add('visible');
    }

    function closeOverlays() {
        els.overlay.classList.remove('visible');
        els.keypad.classList.remove('visible');
        els.modal.classList.remove('visible');
        activeInputId = null;
    }

    // --- Scoring Logic ---
    function submitExam() {
        if(!currentTheme) return;
        if(!confirm("제출하시겠습니까?")) return;

        let score = 0;
        const total = currentTheme.questions.length;
        
        currentTheme.questions.forEach((q, idx) => {
            const input = document.getElementById(`q-${idx}`);
            const userVal = input.value.trim();
            
            input.classList.remove('correct', 'wrong');
            
            // 정답 비교 (문자열)
            if(userVal === q.answer) {
                score++;
                input.classList.add('correct');
            } else {
                input.classList.add('wrong');
            }
        });

        const finalScore = Math.round((score / total) * 100);
        alert(`채점 결과: ${finalScore}점 (${score}/${total})`);

        // Save
        const key = `s4_${currentTheme.id}`;
        const saved = JSON.parse(localStorage.getItem(key)) || { attempts: 0, bestScore: 0 };
        saved.attempts++;
        saved.bestScore = Math.max(saved.bestScore, finalScore);
        localStorage.setItem(key, JSON.stringify(saved));
        
        // Update UI
        els.examStatus.textContent = `시도: ${saved.attempts}/${MAX_ATTEMPTS} (최고: ${saved.bestScore}점)`;
        if(saved.attempts >= MAX_ATTEMPTS) {
            els.submitBtn.disabled = true;
            els.submitBtn.textContent = "제출 횟수 초과";
        }
        
        closeOverlays();
    }

    init();
</script>
</body>

</html>